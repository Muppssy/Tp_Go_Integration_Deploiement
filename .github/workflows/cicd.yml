name: Build the app docker image

on:
  push

jobs:
  test-widgets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run widget tests
        run: |
          if [ -d "./test/widgettests" ]; then
            go test -count=1 -v ./test/widgettests
          else
            echo "No ./test/widgettests package; skipping."
          fi

  # 1) Tests unitaires (lance en parall√®le de "versioning")
  test-unitaire:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true
      - name: Run unit tests (exclude integration)
        run: |
          PKGS=$(go list ./... | grep -v '/test/apitests$' || true)
          if [ -n "$PKGS" ]; then
            go test -count=1 -v $PKGS
          else
            echo "No unit-test packages to run."
          fi

  # 2) Versioning (en parall√®le de "test-unitaire")
  versioning:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.versioning.outputs.version }}
      imageName: ${{ steps.versioning.outputs.imageName }}
    steps:
      - uses: actions/checkout@v4
      - name: Compute versions
        id: versioning
        shell: bash
        run: |
          set -euo pipefail
          version=$(git rev-parse --short HEAD)
          repo_lc=$(echo "$GITHUB_REPOSITORY" | tr '[:upper:]' '[:lower:]')   # GHCR = lowercase
          imageName="ghcr.io/${repo_lc}:${version}"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "imageName=$imageName" >> "$GITHUB_OUTPUT"
          echo "## üîñ New version '$version'" >> "$GITHUB_STEP_SUMMARY"
          echo "## üì¶ Image '$imageName'" >> "$GITHUB_STEP_SUMMARY"

  # 3) Build & Push (ne d√©marre que si versioning **et** tests OK)
  build-and-push:
    runs-on: ubuntu-latest
    needs: [versioning, test-unitaire]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Login to GHCR
        run: echo "${{secrets.GITHUB_TOKEN}}" | docker login ghcr.io -u "${{github.actor}}" --password-stdin
      - name: Build image
        run: docker build -t "${{ needs.versioning.outputs.imageName }}" .
      - name: Push image
        run: docker push "${{ needs.versioning.outputs.imageName }}"

  # 4) (Optionnel) Tests d'API apr√®s le push
  api-tests:
    runs-on: ubuntu-latest
    needs: [build-and-push, versioning, test-widgets]
    permissions:
      contents: read
      packages: read
    services:
      backend:
        image: ${{ needs.versioning.outputs.imageName }}
        credentials:
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
        ports:
          - "8080:8080"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true
      - name: Wait for API (probe /api/cats or /cats)
        shell: bash
        run: |
          for i in {1..30}; do
            for p in /api/cats /cats; do
              code=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8080${p}" || true)
              [ "$code" = "200" ] && exit 0
            done
            sleep 2
          done
          echo "API never replied 200"; exit 1
      - name: Run integration tests
        run: |
          if [ -d "./test/apitests" ]; then
            go test -count=1 -v ./test/apitests
          else
            echo "No ./test/apitests package; skipping."
          fi
